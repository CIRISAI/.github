name: QA Subset

on:
  workflow_call:
    inputs:
      modules:
        description: 'Space-separated QA modules (api billing consent setup handler filter sdk)'
        required: true
        type: string
      ciris_ref:
        description: 'CIRISAgent ref for QA runner'
        default: 'main'
        type: string
      fail_fast:
        description: 'Stop on first failure'
        default: false
        type: boolean
      dry_run:
        description: 'Run in dry-run mode (no actual tests)'
        default: false
        type: boolean
      base_url:
        description: 'CIRIS API base URL for tests'
        default: 'http://localhost:8080'
        type: string

jobs:
  qa-runner:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout CIRISAgent
        uses: actions/checkout@v4
        with:
          repository: CIRISAI/CIRISAgent
          ref: ${{ inputs.ciris_ref }}
          sparse-checkout: |
            tools/qa_runner/
          sparse-checkout-cone-mode: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install QA dependencies
        run: |
          pip install --upgrade pip
          if [ -f tools/qa_runner/requirements.txt ]; then
            pip install -r tools/qa_runner/requirements.txt
          else
            pip install pytest pytest-asyncio httpx aiohttp pydantic
          fi
        shell: bash

      - name: Run QA modules
        id: qa
        env:
          QA_MODULES: ${{ inputs.modules }}
          DRY_RUN: ${{ inputs.dry_run }}
          FAIL_FAST: ${{ inputs.fail_fast }}
          CIRIS_BASE_URL: ${{ inputs.base_url }}
        run: |
          cd tools/qa_runner

          MODULES=($QA_MODULES)
          FAILED=0
          PASSED=0
          SKIPPED=0

          for module in "${MODULES[@]}"; do
            echo ""
            echo "=========================================="
            echo "Running QA module: $module"
            echo "=========================================="

            # Map module name to actual test file
            TEST_FILE="modules/${module}_tests.py"

            if [ "$DRY_RUN" = "true" ]; then
              echo "[DRY RUN] Would run: pytest $TEST_FILE"
              ((PASSED++))
              continue
            fi

            if [ -f "$TEST_FILE" ]; then
              if pytest "$TEST_FILE" -v --tb=short; then
                echo "Module $module: PASSED"
                ((PASSED++))
              else
                echo "Module $module: FAILED"
                ((FAILED++))
                if [ "$FAIL_FAST" = "true" ]; then
                  echo "Fail-fast enabled, stopping"
                  exit 1
                fi
              fi
            else
              echo "Warning: $TEST_FILE not found, skipping"
              ((SKIPPED++))
            fi
          done

          echo ""
          echo "=========================================="
          echo "QA Summary: $PASSED passed, $FAILED failed, $SKIPPED skipped"
          echo "=========================================="

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT

          if [ $FAILED -gt 0 ]; then
            exit 1
          fi
        shell: bash

      - name: Upload QA results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-results-${{ github.run_id }}
          path: |
            tools/qa_runner/qa_reports*/*.json
            tools/qa_runner/*.log
          if-no-files-found: ignore

  # Parallel module jobs for faster execution
  qa-api:
    if: contains(inputs.modules, 'api')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: CIRISAI/CIRISAgent
          ref: ${{ inputs.ciris_ref }}
          sparse-checkout: tools/qa_runner/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pytest pytest-asyncio httpx aiohttp pydantic
          if [ -f tools/qa_runner/requirements.txt ]; then
            pip install -r tools/qa_runner/requirements.txt
          fi

      - name: Run api module
        env:
          CIRIS_BASE_URL: ${{ inputs.base_url }}
        run: |
          cd tools/qa_runner
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "[DRY RUN] api module"
          else
            pytest modules/api_tests.py -v --tb=short || exit 1
          fi

  qa-setup:
    if: contains(inputs.modules, 'setup')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: CIRISAI/CIRISAgent
          ref: ${{ inputs.ciris_ref }}
          sparse-checkout: tools/qa_runner/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pytest pytest-asyncio httpx aiohttp pydantic
          if [ -f tools/qa_runner/requirements.txt ]; then
            pip install -r tools/qa_runner/requirements.txt
          fi

      - name: Run setup module
        env:
          CIRIS_BASE_URL: ${{ inputs.base_url }}
        run: |
          cd tools/qa_runner
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "[DRY RUN] setup module"
          else
            pytest modules/setup_tests.py -v --tb=short || exit 1
          fi

  qa-handler:
    if: contains(inputs.modules, 'handler')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: CIRISAI/CIRISAgent
          ref: ${{ inputs.ciris_ref }}
          sparse-checkout: tools/qa_runner/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pytest pytest-asyncio httpx aiohttp pydantic
          if [ -f tools/qa_runner/requirements.txt ]; then
            pip install -r tools/qa_runner/requirements.txt
          fi

      - name: Run handler module
        env:
          CIRIS_BASE_URL: ${{ inputs.base_url }}
        run: |
          cd tools/qa_runner
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "[DRY RUN] handler module"
          else
            pytest modules/handler_tests.py -v --tb=short || exit 1
          fi
